---
import { ClientRouter } from 'astro:transitions';
import BaseHead from '../components/BaseHead.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import type { GetStaticPathsOptions, Page } from 'astro';
import { type CollectionEntry, getCollection } from 'astro:content';
import Pagination from '../components/Pagination.astro';
import PostPreview from '../components/PostPreview.astro';
import siteConfig from '../data/site-config';
import { sortItemsByDateDesc } from '../utils/data-utils';
import Search from '../components/Search.svelte';

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const posts = (await getCollection('blog')).sort(sortItemsByDateDesc);
  return paginate(posts, { pageSize: siteConfig.postsPerPage || 4 });
}

type Props = { page?: Page<CollectionEntry<'blog'>> };

const { page } = Astro.props;
const posts = (await getCollection('blog')).sort(sortItemsByDateDesc);
const searchablePosts = posts.map(post => ({
  title: post.data.title,
  slug: post.filePath?.replace('src/content/blog/', '').replace('.md', '') ?? ''
}));
---

<!doctype html>
<html lang="en" class="antialiased break-words">
  <head>
    <BaseHead
      title={siteConfig.title}
      description={siteConfig.description}
      image={siteConfig.image}
    />
    <script>
      if (localStorage.theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    </script>
    <ClientRouter />
  </head>
  <body class="bg-main text-main">
    <div class="flex flex-col min-h-screen px-4 md:px-8">
      <Nav />

      <!-- Mobile-only search bar below logo -->
      <div class="block md:hidden w-full mt-4 mb-8">
        <Search client:load posts={searchablePosts} />
      </div>

      <main class="grow w-full max-w-screen-xl mx-auto">
        <div class="flex flex-col md:flex-row">
          <!-- Posts column -->
          <section class="flex-1 px-0 md:px-8">
            {posts.map(post => (
              <PostPreview post={post} class="mb-10 md:mb-12" />
            ))}

            {page && (
              <Pagination page={page} class="my-16 md:my-24" />
            )}
          </section>

          <!-- Sidebar for desktop only search + Bio & Facebook -->
          <aside class="w-full md:w-72 flex-none px-0 md:px-4 space-y-8 mt-8 md:mt-0">
            <!-- Desktop-only search -->
            <div class="hidden md:block">
              <Search client:load posts={searchablePosts} />
            </div>

            <div class="border border-black p-4">
              <h2 class="bg-black text-white text-center text-lg font-semibold py-1">
                Biografía
              </h2>
              <div class="flex flex-col items-center mt-4">
                <img
                  src="/miguel-grau-summary.jpg"
                  alt="Miguel María Grau Seminario"
                  class="w-24 h-24 rounded-full object-cover"
                />
                <h3 class="mt-4 text-center font-bold text-sm">
                  Miguel Maria Grau Seminario
                </h3>
                <p class="mt-2 text-justify text-sm leading-relaxed">
                  Fue un marino y militar peruano, almirante de la Marina de Guerra
                  del Perú. Durante la guerra del Pacífico, comandó el monitor
                  <i>Huáscar</i> y mantuvo a raya a la escuadra chilena durante cinco
                  meses, sucumbiendo finalmente de manera heroica en el combate naval
                  de Angamos, enfrentando a fuerzas superiores.
                </p>
              </div>
            </div>

            <!-- Facebook embed with fixed height & overflow hidden -->
            <div class="border border-black p-4 overflow-hidden">
              <h2 class="bg-black text-white text-center text-lg font-semibold py-1 mb-3">
                Visítanos en Facebook
              </h2>
              <div
                class="fb-page w-full max-w-full"
                style="height:130px; overflow:hidden;"
                data-href="https://www.facebook.com/Miguel.Grau.1834"
                data-tabs="timeline"
                data-width=""
                data-height="130"
                data-small-header="true"
                data-adapt-container-width="true"
                data-hide-cover="false"
                data-show-facepile="false"
              >
                <blockquote
                  cite="https://www.facebook.com/Miguel.Grau.1834"
                  class="fb-xfbml-parse-ignore"
                >
                  <a href="https://www.facebook.com/Miguel.Grau.1834">
                    Miguel Grau
                  </a>
                </blockquote>
              </div>
            </div>
          </aside>
        </div>
      </main>

      <Footer />
    </div>

    <script>
      // @ts-nocheck
      if (!window.fbAsyncInit) {
        window.fbAsyncInit = function() {
          FB.init({ xfbml: true, version: 'v16.0' });
        };
        ((d, s, id) => {
          const fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          const js = d.createElement(s);
          js.id = id;
          js.src = 'https://connect.facebook.net/en_US/sdk.js';
          fjs.parentNode.insertBefore(js, fjs);
        })(document, 'script', 'facebook-jssdk');
      }
    </script>
  </body>
</html>
